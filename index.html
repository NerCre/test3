<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>命をツナグ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app" class="app">

    <!-- Top bar (shown except on Home) -->
    <header id="topbar" class="topbar" aria-label="操作バー">
      <button id="btnBack" class="icon-btn" type="button" aria-label="戻る">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.5 5.5 9 12l6.5 6.5-1.4 1.4L6.2 12l7.9-7.9 1.4 1.4z"/></svg>
        <span>戻る</span>
      </button>

      <div class="topbar-title" aria-hidden="true">命をツナグ</div>

      <button id="btnRestartGlobal" class="icon-btn" type="button" aria-label="最初から">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7a6 6 0 1 1-6 6H4a8 8 0 1 0 13.65-6.65z"/></svg>
        <span>最初から</span>
      </button>
    </header>

    <main class="main">
      <!-- Home -->
      <section id="view-home" class="view active" aria-label="ホーム">
        <!-- QR SCANNER START -->
        <div class="card qr-card" aria-label="QRコード読み取り">
          <div class="card-title">QRコード読み取り</div>

          <div class="qr-actions">
            <button id="qr_btnStart" class="btn btn-primary qr-btn" type="button">開始</button>
            <button id="qr_btnStop" class="btn btn-secondary qr-btn" type="button" disabled>停止</button>
          </div>

          <div id="qr_videoWrap" class="qr-video-wrap hidden">
            <video id="qr_video" class="qr-video" muted playsinline></video>
          </div>

          <div class="qr-result">
            <div class="small">読み取り結果</div>
            <div id="qr_resultText" class="mono qr-result-text">-</div>
            <button id="qr_btnOpen" class="btn btn-primary qr-btn hidden" type="button">開く</button>
          </div>

          <p id="qr_msg" class="small"></p>
        </div>
        <!-- QR SCANNER END -->
        <div class="hero">
          <div class="mascot" aria-hidden="true">
            <!-- Simple "emergency character" (lifebuoy + heart) -->
            <svg viewBox="0 0 160 160" role="img" aria-label="キャラクター">
              <defs>
                <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="#ff6b6b"/>
                  <stop offset="1" stop-color="#d32f2f"/>
                </linearGradient>
              </defs>
              <circle cx="80" cy="80" r="60" fill="#ffffff" stroke="#0d47a1" stroke-width="10"/>
              <path d="M80 116c-18-12-30-22-30-38 0-11 9-20 20-20 7 0 13 4 16 10 3-6 9-10 16-10 11 0 20 9 20 20 0 16-12 26-30 38l-6 4-6-4z" fill="url(#g1)"/>
              <circle cx="62" cy="60" r="6" fill="#0d47a1"/>
              <circle cx="98" cy="60" r="6" fill="#0d47a1"/>
              <path d="M60 82c8 10 32 10 40 0" fill="none" stroke="#0d47a1" stroke-width="6" stroke-linecap="round"/>
              <path d="M80 20v18" stroke="#0d47a1" stroke-width="8" stroke-linecap="round"/>
              <path d="M80 122v18" stroke="#0d47a1" stroke-width="8" stroke-linecap="round"/>
              <path d="M20 80h18" stroke="#0d47a1" stroke-width="8" stroke-linecap="round"/>
              <path d="M122 80h18" stroke="#0d47a1" stroke-width="8" stroke-linecap="round"/>
            </svg>
          </div>
          <h1 class="app-title">命をツナグ</h1>
          <p class="tagline">状況に応じて適切な行動をとれるようサポートします。</p>
        </div>

        <div class="button-container">
          <button id="btnStartEmergency" class="btn btn-emergency" type="button">
            緊急事態<br /><span class="en">(EMERGENCY)</span>
          </button>
          <button id="btnStartUnsure" class="btn btn-unsure" type="button">
            判断に迷う時<br /><span class="en">(UNSURE?)</span>
          </button>
        </div>

        <div class="home-footer">
          <button id="btnAdmin" class="link-btn" type="button" aria-label="管理画面">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19.14,12.94c0.04-0.31 0.06-0.63 0.06-0.94 0-0.31-0.02-0.63-0.06-0.94l2.03-1.58c0.18-0.14 0.23-0.41 0.12-0.61l-1.92-3.32c-0.11-0.2-0.35-0.28-0.56-0.2l-2.39 0.96c-0.5-0.38-1.04-0.7-1.63-0.94L14.4,2.5C14.37,2.22 14.13,2 13.85,2h-3.7c-0.28,0-0.52,0.22-0.55,0.5L9.24,5.04c-0.59,0.24-1.13,0.56-1.63,0.94L5.22,5.02c-0.21-0.08-0.45,0-0.56,0.2L2.74,8.54c-0.11,0.2-0.06,0.46,0.12,0.61l2.03,1.58C4.85,11.04 4.83,11.36 4.83,11.67c0,0.31 0.02,0.63 0.06,0.94L2.86,14.19c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.11,0.2 0.35,0.28 0.56,0.2l2.39-0.96c0.5,0.38 1.04,0.7 1.63,0.94l0.36,2.54c0.03,0.28 0.27,0.5 0.55,0.5h3.7c0.28,0 0.52-0.22 0.55-0.5l0.36-2.54c0.59-0.24 1.13-0.56 1.63-0.94l2.39 0.96c0.21,0.08 0.45,0 0.56-0.2l1.92-3.32c0.11-0.2 0.06-0.46-0.12-0.61L19.14,12.94z M12,15.5c-1.93,0-3.5-1.57-3.5-3.5S10.07,8.5,12,8.5s3.5,1.57,3.5,3.5S13.93,15.5,12,15.5z"/></svg>
            <span>管理</span>
          </button>
          <p class="small-note">※ このアプリはスマホ縦向き利用を想定しています。</p>
        </div>
      </section>

      <!-- Status select -->
      <section id="view-status" class="view" aria-label="状況選択">
        <h2>状況を選択してください</h2>
        <div id="statusGrid" class="grid" role="list"></div>
        <p class="small">※ 状況と所属に応じて、連絡先・文面を自動作成します。</p>
      </section>

      <!-- Company select -->
      <section id="view-company" class="view" aria-label="所属選択">
        <h2>所属を選択してください</h2>
        <div id="companyList" class="list" role="list"></div>
      </section>

      <!-- Person select -->
      <section id="view-person" class="view" aria-label="対象者選択">
        <h2>誰が（対象者）</h2>
        <div id="kanaBar" class="kana-bar" aria-label="読みで絞り込み"></div>
        <div id="personList" class="list" role="list"></div>
        <p class="small">※ 手入力せずに探せるよう、読み（かな）で絞り込みます。</p>
      </section>

      <!-- Body part select (for pain/bleeding) -->
      <section id="view-body" class="view" aria-label="部位選択">
        <h2 id="bodyTitle">部位を選択してください</h2>
        <p id="bodyQuestion" class="question">出血・痛みの部位をタップしてください。</p>

        <div id="bodyWrap" class="body-wrap">
          <svg id="bodySvg" viewBox="0 0 220 520" aria-label="人体シルエット">
            <!-- head -->
            <circle cx="110" cy="55" r="32" class="body-part" data-part="head" />
            <!-- neck -->
            <rect x="98" y="87" width="24" height="18" rx="10" class="body-part" data-part="neck" />
            <!-- torso -->
            <rect x="70" y="105" width="80" height="130" rx="26" class="body-part" data-part="torso" />
            <!-- left arm -->
            <rect x="30" y="125" width="34" height="120" rx="16" class="body-part" data-part="leftArm" />
            <!-- right arm -->
            <rect x="156" y="125" width="34" height="120" rx="16" class="body-part" data-part="rightArm" />
            <!-- left hand -->
            <rect x="26" y="245" width="42" height="38" rx="14" class="body-part" data-part="leftHand" />
            <!-- right hand -->
            <rect x="152" y="245" width="42" height="38" rx="14" class="body-part" data-part="rightHand" />
            <!-- hips -->
            <rect x="74" y="235" width="72" height="48" rx="18" class="body-part" data-part="hips" />
            <!-- left leg -->
            <rect x="78" y="285" width="34" height="150" rx="16" class="body-part" data-part="leftLeg" />
            <!-- right leg -->
            <rect x="108" y="285" width="34" height="150" rx="16" class="body-part" data-part="rightLeg" />
            <!-- left foot -->
            <rect x="72" y="435" width="44" height="34" rx="14" class="body-part" data-part="leftFoot" />
            <!-- right foot -->
            <rect x="104" y="435" width="44" height="34" rx="14" class="body-part" data-part="rightFoot" />
          </svg>
        </div>

        <div class="helper-card">
          <div class="helper-title">選択中</div>
          <div id="bodySelectedLabel" class="helper-value">未選択</div>
        </div>

        <div class="footer-actions">
          <button id="btnBodyNext" class="btn btn-primary" type="button" disabled>
            次へ
          </button>
        </div>
      </section>

      <!-- Result -->
      
  <section id="view-emergency" class="view" aria-label="救急要請中">
    <h2 class="view-title">救急要請</h2>

    <div class="call-wrap" role="status" aria-live="polite">
      <div class="call-circle">
        <div class="call-icon" aria-hidden="true">🚑</div>
        <div class="call-text">救急要請中</div>
        <div class="call-sub small">（デモ：実際の救急要請は行いません）</div>
      </div>
    </div>

    <div class="actions">
      <button id="btnOpenMailEmergency" type="button" class="btn btn-primary">
        メールアプリを開く
      </button>
    </div>

    <p class="small muted">
      ※ 送信内容のプレビューは表示しません（緊急事態の想定）。
    </p>
  </section>

<section id="view-result" class="view" aria-label="判断結果">
        <h2>判断結果</h2>

        <div class="summary-card">
          <div class="summary-row"><span>状況</span><strong id="sumStatus">-</strong></div>
          <div class="summary-row"><span>所属</span><strong id="sumCompany">-</strong></div>
          <div class="summary-row"><span>対象者</span><strong id="sumPerson">-</strong></div>
          <div class="summary-row" id="sumDetailRow"><span>詳細</span><strong id="sumDetail">-</strong></div>
        </div>

        <div class="result-card">
          <p id="resultText" class="result-message"></p>
        </div>

        <div class="result-actions">
          <button id="btnActionEmergency" class="btn btn-emergency" type="button">
            緊急要請する
          </button>
          <button id="btnActionObserve" class="btn btn-secondary" type="button">
            様子を見る
          </button>
        </div>

        <div class="mail-preview">
          <div class="mail-preview-title">送信内容（プレビュー）</div>
          <div class="mail-preview-row"><span>宛先</span><div id="mailToPreview" class="mono">-</div></div>
          <div class="mail-preview-row"><span>件名</span><div id="mailSubjectPreview" class="mono">-</div></div>
          <div class="mail-preview-row"><span>本文</span><pre id="mailBodyPreview" class="mono pre">-</pre></div>

          <div class="mail-preview-actions">
            <button id="btnOpenMail" class="btn btn-primary" type="button">メールアプリを開く</button>
            <button id="btnCopyMail" class="btn btn-secondary" type="button">コピー</button>
          </div>

          <p class="small">
            ※ ブラウザから自動送信はできないため、メールアプリに文面を引き継ぎます（mailto）。
          </p>
        </div>
      </section>

      <!-- Admin -->
      <section id="view-admin" class="view" aria-label="管理画面">
        <h2>管理画面</h2>

        <div id="adminGate" class="admin-gate">
          <p class="small">パスワードで保護されています。</p>

          <div id="adminFirstSet" class="card hidden">
            <div class="card-title">初回設定</div>
            <label class="field">
              <span>新しいパスワード</span>
              <input id="adminNewPass1" type="password" autocomplete="new-password" />
            </label>
            <label class="field">
              <span>確認</span>
              <input id="adminNewPass2" type="password" autocomplete="new-password" />
            </label>
            <button id="btnAdminSetPass" class="btn btn-primary" type="button">設定する</button>
          </div>

          <div id="adminLogin" class="card hidden">
            <div class="card-title">ログイン</div>
            <label class="field">
              <span>パスワード</span>
              <input id="adminPass" type="password" autocomplete="current-password" />
            </label>
            <button id="btnAdminLogin" class="btn btn-primary" type="button">ログイン</button>
          </div>

          <p id="adminGateMsg" class="small"></p>
        </div>

        <div id="adminPanel" class="hidden">
          <div class="admin-tabs" role="tablist" aria-label="管理タブ">
            <button class="tab active" data-tab="companies" type="button">会社</button>
            <button class="tab" data-tab="staff" type="button">職員</button>
            <button class="tab" data-tab="messages" type="button">文面</button>
            <button class="tab" data-tab="export" type="button">入出力</button>
          </div>

          <!-- Companies -->
          <section class="admin-tab active" data-tab-panel="companies">
            <div class="card">
              <div class="card-title">会社（所属）</div>
              <div id="adminCompanies" class="admin-list"></div>

              <div class="divider"></div>
              <div class="card-subtitle">追加</div>
              <div class="form-row">
                <input id="newCompanyName" type="text" placeholder="会社名（例：自社）" />
                <input id="newCompanyEmails" type="text" placeholder="送信先メール（カンマ区切り）" />
                <button id="btnAddCompany" class="btn btn-primary" type="button">追加</button>
              </div>
            </div>

            <div class="card">
              <div class="card-title">共通連絡先（部署等）</div>
              <div class="form-col">
                <label class="field">
                  <span>安全課本部</span>
                  <input id="gcSafetyHQ" type="text" placeholder="safety@example.com" />
                </label>
                <label class="field">
                  <span>現場救護班</span>
                  <input id="gcRescueTeam" type="text" placeholder="rescue@example.com" />
                </label>
                <label class="field">
                  <span>救急指令センター</span>
                  <input id="gcAmbulance" type="text" placeholder="dispatch@example.com" />
                </label>
                <button id="btnSaveGlobalContacts" class="btn btn-primary" type="button">保存</button>
              </div>
            </div>
          </section>

          <!-- Staff -->
          <section class="admin-tab" data-tab-panel="staff">
            <div class="card">
              <div class="card-title">職員（対象者）</div>
              <div class="form-row">
                <select id="staffCompanyFilter"></select>
                <button id="btnStaffFilter" class="btn btn-secondary" type="button">表示</button>
              </div>
              <div id="adminStaff" class="admin-list"></div>

              <div class="divider"></div>
              <div class="card-subtitle">追加</div>
              <div class="form-grid">
                <select id="newStaffCompany"></select>
                <input id="newStaffName" type="text" placeholder="氏名（例：山田 太郎）" />
                <input id="newStaffKana" type="text" placeholder="よみ（かな/カナ 例：やまだたろう）" />
                <button id="btnAddStaff" class="btn btn-primary" type="button">追加</button>
              </div>
            </div>
          </section>

          <!-- Messages -->
          <section class="admin-tab" data-tab-panel="messages">
            <div class="card">
              <div class="card-title">状況と文面</div>
              <p class="small">状況ごとに「推奨表示文」や、緊急/様子見の送信先（部署）を調整できます。</p>
              <div id="adminSituations" class="admin-list"></div>
            </div>

            <div class="card">
              <div class="card-title">パスワード変更</div>
              <div class="form-grid">
                <input id="adminChangeOld" type="password" placeholder="現在のパスワード" />
                <input id="adminChangeNew1" type="password" placeholder="新しいパスワード" />
                <input id="adminChangeNew2" type="password" placeholder="確認" />
                <button id="btnAdminChangePass" class="btn btn-primary" type="button">変更</button>
              </div>
              <p id="adminChangeMsg" class="small"></p>
            </div>
          </section>

          <!-- Export/Import -->
          <section class="admin-tab" data-tab-panel="export">
            <div class="card">
              <div class="card-title">設定の入出力</div>
              <div class="form-row">
                <button id="btnExportJson" class="btn btn-primary" type="button">設定をJSONで書き出し</button>
                <label class="btn btn-secondary file-btn" for="importJson">
                  JSONを読み込み
                </label>
                <input id="importJson" type="file" accept="application/json" />
              </div>
              <p class="small">※ 端末内（localStorage）に保存されます。共有したい場合はJSONを書き出してください。</p>
              <p id="adminIoMsg" class="small"></p>
            </div>
          </section>

        </div>
      </section>

      <!-- Toast -->
      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </main>
  </div>

  <!-- QR SCANNER START -->
  <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js" crossorigin="anonymous"></script>
  <!-- QR SCANNER END -->
  <script src="script.js"></script>
</body>
</html>
